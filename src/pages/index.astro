---
import Layout from '../layouts/Layout.astro';
---

<Layout title="BIG CORNER - Hamburguesas">
  <section class="hero">
    <div class="hero-content">
      <div class="hero-column">
        <img id="logo-img" src="" alt="Logo" class="hero-logo" />
      </div>
      <div class="hero-column">
        <h1 id="titulo-local">Cargando...</h1>
        <p id="horario">Cargando...</p>
        <a id="whatsapp-button" class="btn hero-btn" target="_blank">Cargando...</a>
      </div>
    </div>
  </section>

  <section class="menu" id="menu">
    <h2>Menú</h2>
    <p id="menu-subtitulo" class="menu-subtitle"></p>
    <div class="burger-list" id="burger-list"></div>
  </section>

  <section class="about" id="about">
    <h2>Sobre Nosotros</h2>
    <p id="descripcion-local"></p>
  </section>

  <section class="reviews" id="reviews">
    <h2>Lo que dicen nuestros clientes</h2>
    <div id="reviews-container"></div>
  </section>

  <div id="burger-modal" class="modal hidden">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <img id="modal-img" src="" alt="Hamburguesa" />
      <h3 id="modal-title"></h3>
      <p id="modal-description"></p>

      <form id="order-form" onsubmit="sendOrder(event)">
        <label for="quantity">Cantidad:</label>
        <input type="number" id="quantity" name="quantity" min="1" value="1" required />

        <div class="price-line">
          <label><strong>Precio por unidad:</strong> <span id="unit-price">$0</span></label>
          <label><strong>Total:</strong> <span id="order-total">$0</span></label>
        </div>

        <label for="address">Dirección de entrega:</label>
        <input type="text" id="address" name="address" required />

        <label for="comment">Comentario adicional:</label>
        <textarea id="comment" name="comment"></textarea>

        <input type="hidden" id="product-name" name="product-name" />
        <button type="submit">Pedir por WhatsApp</button>
      </form>

      <div class="modal-nav">
        <button id="prev-btn" onclick="prevProduct()">← Anterior</button>
        <button id="next-btn" onclick="nextProduct()">Siguiente →</button>
        <button id="toggle-cart-btn" class="btn"></button>
      </div>
    </div>
  </div>

  <section class="cart-section">
    <h2>Tu pedido</h2>
    <div id="cart-summary"></div>
  </section>

  <section class="contact" id="contact">
    <h2>Contacto</h2>
    <p>Contactanos por nuestras redes sociales o hacé tu pedido directamente.</p>
    <div class="contact-methods">
      <a id="instagram-link" target="_blank">
        <img src="/images/instagram-icon.png" alt="Instagram" class="icon" />
      </a>
      <a id="whatsapp-contact" target="_blank">
        <img src="/images/whatsapp-icon.png" alt="WhatsApp" class="icon" />
      </a>
    </div>
  </section>

  <footer class="footer">
    <p>
      Sitio desarrollado por <a href="https://marketing-bso.netlify.app/" target="_blank" style="color: inherit; text-decoration: underline;">BSO Web Studio</a>
    </p>
    <p>&copy; <script>document.write(new Date().getFullYear())</script> <span id="footer-nombre">BIG CORNER</span>. Todos los derechos reservados.</p>
  </footer>

  <!-- PapaParse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js" defer></script>

  <!-- Modal logic -->
  <script src="/scripts/modal.js" defer></script>

  <!-- Datos dinámicos -->
  <script>
    window.addEventListener('DOMContentLoaded', () => {
      const baseId = '1oSXRJkVeD3napDd9bltITSA4snw4uqOgXzLtfav05yo';

      const urls = {
        negocio: `https://docs.google.com/spreadsheets/d/${baseId}/gviz/tq?tqx=out:csv&sheet=negocio`,
        productos: `https://docs.google.com/spreadsheets/d/${baseId}/gviz/tq?tqx=out:csv&sheet=productos`,
        resenas: `https://docs.google.com/spreadsheets/d/${baseId}/gviz/tq?tqx=out:csv&sheet=resenas`
      };

      function fetchCSV(url) {
        return fetch(url)
          .then(res => res.text())
          .then(csv => {
            const parsed = Papa.parse(csv, { header: false }).data;
            const headers = parsed[0].map(h => h.trim().toLowerCase());
            return parsed.slice(1).map(row => {
              const obj = {};
              headers.forEach((key, i) => {
                obj[key] = row[i]?.trim?.() ?? '';
              });
              return obj;
            });
          });
      }

      Promise.all([
        fetchCSV(urls.negocio),
        fetchCSV(urls.productos),
        fetchCSV(urls.resenas)
      ]).then(([negocio, productos, resenas]) => {
        const data = Object.fromEntries(negocio.map(item => [item.clave, item.valor]));
        document.getElementById('logo-img').src = data.logo;
        document.getElementById('logo-img').alt = data.nombre;
        document.getElementById('titulo-local').textContent = data.nombre;
        document.getElementById('horario').textContent = data.horario;
        document.getElementById('menu-subtitulo').textContent = data.subtitulo_menu;
        document.getElementById('descripcion-local').textContent = data.descripcion;
        document.getElementById('whatsapp-button').href = `https://wa.me/${data.whatsapp}?text=${encodeURIComponent(data.mensaje_boton_whatsapp)}`;
        document.getElementById('whatsapp-button').textContent = data.texto_boton_whatsapp;
        document.getElementById('instagram-link').href = data.instagram;
        document.getElementById('whatsapp-contact').href = `https://wa.me/${data.whatsapp}?text=${encodeURIComponent(data.mensaje_inicio_chat)}`;
        document.getElementById('footer-nombre').textContent = data.nombre;

        window.dynamicWhatsapp = data.whatsapp;

        const list = document.getElementById('burger-list');
        window.dynamicProducts = productos.filter(row => row.nombre && row.imagen).map(row => ({
          name: row.nombre,
          description: row.descripcion,
          image: row.imagen,
          price: Number(row.precio)
        }));

        list.innerHTML = window.dynamicProducts.map((product, index) => `
          <div class="burger-card" onclick="openModalFromList(${index})">
            <img src="${product.image}" alt="${product.name}" />
            <h3>${product.name}</h3>
            <p>${product.description}</p>
            <p class="price">$${product.price}</p>
          </div>
        `).join('');

        document.getElementById('reviews-container').innerHTML = resenas.map(r => `
          <div class="review">
            <p>“${r.cita.trim()}”</p>
            <span>- ${r.autor.trim()}</span>
          </div>
        `).join('');
      }).catch(err => {
        console.error("Error cargando los datos:", err);
      });
    });
  </script>
</Layout>
